<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>03. 퍼센트로딩중</title>
        <!-- 제이쿼리 라이브러리 CDN -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>

        <!-- 제이쿼리 UI CDN -->
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
        <style>
            /* 로딩중 이미지 */
            .loading {
                position: fixed;
                top: 50%;
                left: 50%;
                z-index: 9999;
                transform: translate(-50%, -50%);
            }
            /* 화면에 넣을 이미지 */
            .timg {
                width: 100%;
            }
            /* 원을 담는 박스 */
            .btns {
                /* position: relative; */
                width: 15vw;
                aspect-ratio: 1/1;
                background-image: linear-gradient(to left, hotpink, lightgreen, lightblue);
                border-radius: 50%;
            }

            /* 비율밀기 */
            .btns::before {
                content: "";
                display: block;
                padding-top: 100%;
            }

            /* svg셋팅 */
            .btns svg {
                position: absolute;
                top: 0;
                /* 부모박스가 패딩탑으로 비율밀기하므로
앱솔로 부모박스 맨위로 위치고정! 
svg 자체는 viewBox설정 때문에 채우기 비율유지함!*/
            }

            /* circle 설정 */
            .c1 {
                fill: none;
                /* 채우기-기본색은 검정색(transparent-투명,none-없음) */
                stroke: rgb(255, 0, 242);
                /* 선색(안쓰면 안나옴) */
                stroke-width: 10;
                /* 선두께는 안쓰면 1px, 단위없으면 px */
                stroke-linecap: round;
                /* 선끝둥글게 */

                stroke-dasharray: 300%;
                /* 데쉬어레이를 50%로 놓고 선,공백이 몇조각나는지 본다!
                50% * 6조각 = 300% 즉, 선으로만 채우는 크기임! */

                stroke-dashoffset: 300%;
                /* 데쉬어레이와 같은 크기를 데쉬옵셋에 주면 시작점이
                밀려서 공백부터 시작함-> 선이 숨겨지는 효과가 생김! */

                /* 트랜지션: 퍼센트 증가에 따른 애니메이션 */
                transition: 0.1s linear;
            }

            /* 퍼센트 글자박스 */
            .txt {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 5vw;
                text-shadow: 2px 2px 2px #000;
                color: #fff;
            }
        </style>
        <script>
            const isrc = ["https://img.freepik.com/free-vector/night-ocean-landscape-full-moon-stars-shine_107791-7397.jpg?w=2000", "https://marketplace.canva.com/EAE-xnqWvJk/1/0/1600w/canva-retro-smoke-and-round-light-desktop-wallpapers-JLofAI27pCg.jpg", "https://images3.alphacoders.com/131/1311991.jpeg", "https://www.grafico.com.au/assets/uploads/MelbourneMap.jpg"];

            /************************
                [ 로딩중 표시는 어떤 기준으로 하는가 ]
                - 로드 이벤트 종류에 따라 아래  2가지가 있다.
                1. DOMContentLoaded - HTML태그만 다 그려지면 발생함
                2. load - 대상 내부에 이미 넣은 태그의 컨텐츠가 모두 로딩되면 발생(이미지 내용, 동영상 등 포함)

                -> 위의 개념을 볼 때 load 이벤트 구역을 사용해야 할 것 같지만... JS로 만들어서 동적으로 생성하는 태그요소를
                모두 로딩할 때까지 기다려야함. 그러나 일반 load이벤트로는 이것을 체크하지 못함

                promise를 사용해야함!
                promise 구역에 태그로드 코드를 넣어서 기다리게 한 후 로딩되면 다음을 실행함

                [ 로딩중 표시는 어떻게 하나 ]
                1. 태그를 넣기 전 로딩중 이미지(바)를 미리 실행
                2. 태그 넣기 함수 실행(promise안에 위치)
                3. 로딩후 promise then 또는 async await 사용한 로딩중 이미지 없앰
            ************************/

            // 이벤트 발생확인하기
            // JS 실행구역 -> DOMContentLoaded -> load
            window.addEventListener("DOMContentLoaded", () => {
                // body가 로딩되면 체크
                document.body.onload = () => {
                    console.log("body 로딩완료");
                };

                // 로딩중 이미지 넣기 함수
                const firstDo = () => {
                    document.body.innerHTML += `
                    <div class="btns loading">
                    <!-- 숫자퍼센트박스 -->
                    <span class="txt"><b class="ptxt">0</b>%</span>
                    <!-- svg박스 -->
                    <svg viewBox="0 0 200 200">
                        <circle
                            class="c1"
                            cx="100"
                            cy="100"
                            r="95"
                            transform="rotate(-90,100,100)"
                        ></circle>
                    </svg>
                </div>
                    `;

                };

                // 페이지에 많은 양의 이미지 넣기 함수
                // const addimg = () => {
                //     for (let i = 0; i < 200; i++) {
                //         isrc.forEach((v) => {
                //             document.body.innerHTML += `
                //                 <img class="timg" src="${v}" alt="test">
                //             `;
                //         });
                //     }
                // };
                // addimg();

                // 이미지 컨텐츠를 로딩하는 함수를 Promise하자
                // async / await를 사용함
                // async 함수 안에 promise 세계를 만들어줌
                async function setIt(fn) {
                    //fn은 실행 코드 함수
                    //  재사용성을 위해 실행할 함수를 받는다
                    let doit = new Promise(function (success) {
                        // 시간이 걸리는 코드
                        fn();
                        // addimg();
                        // 위의 코드가 실행되면 호출
                        success("다 됐음");
                    });

                    // promise가 보장하는 코드 실행 후 실행함수
                    const thenDoit = (txt) => {
                        // success에서 전달하는 값 받기
                        console.log("이게 뭐: ", txt);

                        // 로딩바를 없앰
                        document.querySelector(".loading").remove();
                    };

                    // promise호출하기
                    thenDoit(await doit);
                    // 실행순서
                    // await 뒤에 doit함수를 먼저 호출
                    // doit은 promise 생성자 함수
                    // doit에서 시간이 걸리는 코드가 모두 끝나면
                    // success 가 실행되고 thenDoit을 호출함
                    // thenDoit은 success가 리턴되는 값을 받을 때까지 기다림
                }
                // 먼저 로딩표시 이미지 보이기 함수 호출
                firstDo();
                // async / await 는 반드시 밖에서 호출해주어야 함
                // 약간의 시차를 두고 호출
                // setTimeout(() => setIt(addimg), 100);
                // 로딩와와 실행처리구역을 구분하여
                // 로딩바 이미지가 처리이미지와 같이 처리되지 않도록
                // 비동기적으로 처리해야 로딩바가 별도로 화면에 먼저 나타날 수 있다.

                console.log("DOM로드");
            });
            $(()=>{
                const btns = $(".btns")
                function progFn(seq, perc) {
                    
                    
    
                    console.log("퍼센트", seq, perc);
                    // 해당순번의 숫자요소
                    let ptxt = btns.eq(seq).find(".ptxt");
                    // 퍼센트 증가
                    //  개별 숫자 텍스트 읽어오기
                    // 변경할 숫자변수
                    let num = Number(ptxt.text());
                    num++;
                    ptxt.text(num);
                    // 계산하기
                    let calc = (300 * (100 - num)) / 100;
                    // 계산법 : 전체옵션값 X (100-현재퍼센트)/100
                    // 100-현재퍼센트 한 이유는 300에서 숫자가 0으로 작아져야 하기 때문
                    // 첫번째 퍼센트원 진행하기
                    btns.eq(seq)
                        .find("circle")
                        .css({
                            strokeDashoffset: calc + "%",
                        });
                    // 첫번째 퍼센트원 숫자
                    // 재귀호출하기 : 기준 수 보다 작을 때 까지
                    // 기준수의 숫자가 원하는 %가 된다
                    if (num < perc) {
                        setTimeout(() => progFn(seq, perc), 30);
                    }
                }
                progFn(0,80)
            })

            console.log("JS시작");
        </script>
    </head>
    <body></body>
</html>
