<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Promise 적용연습2 - async, await</title>
        <script>
         function 화면뿌려(이거){
            document.getElementById("show").innerHTML += 이거 + "<br/>";
        }

        window.addEventListener("load",function(){
        // JSON 데이터를 로딩하여 읽은 후 데이터를 활용하도록 Promise를 적용함

        
        /*************************************************
            
            [ JSON파일 내부 형식 ]\

            1. JSON 파일은 내부형식이 객체형식이지만
            자바스크립트에서 속셩명을 변수형으로 쓰는 것처럼 사용할 수 없다
            -> 반드시 쌍따옴표로 싸서 문자형으로 표현해야만 한다.
            
            2. JSON 파일 내부에 JS 주석문은 쓸 수 없다.
            (vscode의 settings.json에서 주석문은 vscode에서 별도의 처리를 하므로 사용가능했던 것임.)
            
            3. JSON은 최상위 형식으로 객체/배열로써 하나만 존재할 수 있다.
                예) {속성명: 값, ....} / [{속성명: 값, ....}, {속성명:값, ....}]
            
            4. JSON 맨 마지막 항목 뒤에 콤마를 남길 수 없다(에러가 뜸)
            -> Javascript에서는 마지막 콤마 허용함
                
        *************************************************/



            async function myAFn(){
                // 1. 변수 = new Promise((성공함수)=>{코드})
                // Promise 코드에 XMLHttpRequest 객체로 JSON 로딩함
                const myProm = new Promise((prFn)=>{
                    // 1) XMLHttpRequest() 인스턴스 생성
                        let ajax  = new XMLHttpRequest();

                        // 2) 비동기 파일 요청(JSON파일)
                        ajax.open("GET", "./defaultSettings.json");
                        //  -> JSON파일은 응답형식(reponseType)을 "json"으로 설정 필수                
                        ajax.responseType = "json";
                        // 만약 responseType설정을 하지 않으면 "text"가 기본 값이다.
                        // 이런경우에는 JSON파일형식이 잘못되었어도 읽어올 수 있음

                        // 3) 결과 리턴 onload이벤트 함수구역
                        ajax.onload = function(){
                            console.log(ajax.status);
                            if(ajax.status == 200){
                                // Promise 성공함수를 통하여 JSON 데이터 전달하기
                                prFn(ajax.response);
                                // responseType을 "json"으로 설정했으므로 결과값은 JSON으로 전달됨
                            }else{
                                console.log(ajax.statusText);
                                // 결과값이 null 이면 JSON파일 내부 형식이 잘못된 경우이다. 이런경우  JSON파일로 취급받지 못해 아무것도 로딩못한 결과임
                            }
                        }/////////// onload 함수구역
                        // 4) 비동기 요청 보내기: send()
                        ajax.send();
                    })//////////// myProm 인스턴스

                // html코드 생성 함수
                const makeHtml = obj=>{ //obj는 JSON객체
                    let hcode = `
                        <h1>우리집 멍뭉이 정보</h1>
                        <ol>
                            <li>이름 : ${obj[0]["멍뭉이이름"]}</li>
                            <li>사는곳 : ${obj[0]["멍뭉이사는곳"]}</li>
                            <li>태생지 : ${obj[0]["멍뭉이출신지"]}</li>
                            <li>간식 : ${obj[0]["멍뭉이간식"]}</li>
                        </ol>
                        <h1>우리집 야웅이 정보</h1>
                        <ol>
                            <li>이름 : ${obj[1]["야웅이름"]}</li>
                            <li>사는곳 : ${obj[1]["야웅사는곳"]}</li>
                            <li>태생지 : ${obj[1]["야웅출신지"]}</li>
                            <li>간식 : ${obj[1]["야웅간식"]}</li>
                        </ol>
                    `;
                    return hcode;
                }

                // 먼저 변수에 await를 사용한  Promise 리턴값 할당
                let temp = await myProm;
            
                // 화면출력하기
                화면뿌려(makeHtml(temp));

                /***********************
                    [ await 사용시 주의사항 ]
                    await에서 Promise 인스턴스를 변수에 담지 않고 사용하면 pending(보류)처리 된 인스턴스가 전달되는 경우가 생김
                    
                    따라서, 변수에 await Promise 인스턴스를 담아서 그 리턴값을 확정한 후 
                    (변수할당이란 값을 특정 주소지에 넣고 사용할 준비를 하는 것)
                    
                    그 값으로 함수를 다시 호출하던지 후속 코드 작업을 하면된다.
                    -> await를 담은 변수에 값이 할당되기 전에는 그 값을 이용하는 코드도 모두 대기상태이다.
                    
                ***********************/
            }   

        myAFn();



        })

        </script>
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Gamja+Flower&display=swap");
            body {
                background-image: linear-gradient(to bottom, #494949, gray);
                background-repeat: no-repeat;
                background-attachment: fixed;
                text-align: center;
            }
            #show {
                font-family: "Gamja Flower", cursive;
                font-size: 4vw;
                background-image: linear-gradient(to bottom, lightgreen, pink, orangered, aquamarine);
                background-clip: text;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-repeat: no-repeat;
                font-weight: bold;
            }
            #doc{
                width: 50%;
                height: 50vh;
                margin: 0 auto;
            }
        </style>
    </head>
    <body>
        <div id="show"></div>
        <div id="doc"></div>
    </body>
</html>
